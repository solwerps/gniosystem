// prisma/schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

/* =========================
 * Enums (globales)
 * ========================= */

enum Role {
  ADMIN
  CONTADOR
  EMPRESA
}

enum TenantType {
  PERSONAL
  COMPANY
}

enum TenantRole {
  OWNER
  COLLABORATOR
  ACCOUNTANT
  EMPRESA_USER
}

enum DebeHaber {
  DEBE
  HABER
}

enum PrincipalDetalle {
  P
  D
}

enum TipoNomen {
  BALANCE_GENERAL
  ESTADO_RESULTADOS
  CAPITAL
}

enum Naturaleza {
  ACTIVO
  PASIVO
  CAPITAL
  INGRESOS
  COSTOS
  GASTOS
  OTROS_INGRESOS
  OTROS_GASTOS
  REVISAR
}

enum TaskEstado {
  PRIORIDAD
  PENDIENTE
  EN_TRABAJO
  REALIZADO
}

enum AccountingMode {
  CAJA
  DEVENGO
}

enum CondicionPago {
  CONTADO
  CREDITO
}

// Empresa
enum RazonSocial {
  Individual
  Juridico
}

/* =========================
 * Usuarios / Tenancy
 * ========================= */

model User {
  id              Int       @id @default(autoincrement())
  username        String    @unique
  email           String    @unique
  passwordHash    String
  role            Role
  name            String?
  phone           String?
  companyName     String?
  nit             String?
  dpi             String?
  appointmentDate DateTime?
  prestationType  String?
  status          String?
  country         String?
  address         String?
  photoUrl        String?
  photoPublicId   String?
  createdAt       DateTime  @default(now())

  memberships    Membership[]
  tenantsCreated Tenant[]     @relation("UserCreatedTenants")

  tareasAsignadas Tarea[]

  nomenclaturasCreadas Nomenclatura[] @relation("UserOwnedNomenclaturas")

  // ðŸ”™ BitÃ¡cora Conta Cox
  bitacora_registros Bitacora[]
  cierres_mensuales  CierreMensual[] @relation("UserClosedPeriods")
}

model Tenant {
  id          Int        @id @default(autoincrement())
  type        TenantType
  slug        String     @unique
  displayName String
  createdById Int

  createdBy User @relation("UserCreatedTenants", fields: [createdById], references: [id])

  memberships Membership[]
  createdAt   DateTime     @default(now())

  nomenclaturas   Nomenclatura[]
  regimenIvaFilas RegimenIvaFila[]
  regimenIsrFilas RegimenIsrFila[]
  tareas          Tarea[]
  empresas        Empresa[]   // ðŸ”— Todas las empresas de este entorno contable
}

model Membership {
  userId   Int
  tenantId Int
  role     TenantRole @default(OWNER)

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([userId, tenantId])
}

/* =========================
 * Contabilidad
 * ========================= */

model Nomenclatura {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  localId     Int
  ownerUserId Int?
  nombre      String
  descripcion String?
  versionGNIO String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  ownerUser User? @relation("UserOwnedNomenclaturas", fields: [ownerUserId], references: [id])

  cuentas NomenclaturaCuenta[]

  // ðŸ”™ Back-relation hacia Afiliaciones (nombrada)
  empresasAfiliadas Afiliaciones[] @relation("Afiliaciones_Nomenclatura")

  @@unique([tenantId, localId])
  @@index([tenantId, localId])
  @@index([tenantId])
}

model NomenclaturaCuenta {
  id               Int    @id @default(autoincrement())
  nomenclaturaId   Int
  orden            Int
  cuenta           String
  descripcion      String
  debeHaber        String
  principalDetalle String
  nivel            Int
  tipo             String
  naturaleza       String

  lockCuenta           Boolean @default(false)
  lockDescripcion      Boolean @default(false)
  lockDebeHaber        Boolean @default(false)
  lockPrincipalDetalle Boolean @default(false)
  lockNivel            Boolean @default(false)
  lockTipo             Boolean @default(false)
  lockNaturaleza       Boolean @default(false)
  lockAdd              Boolean @default(true)
  lockDelete           Boolean @default(true)
  isPlantilla          Boolean @default(false)

  nomenclatura Nomenclatura @relation(fields: [nomenclaturaId], references: [id])

  // ðŸ”™ Back-relation con cuentas bancarias GNIO
  cuentasBancarias CuentaBancaria[]

  // ðŸ”™ Back-relations con documentos y partidas Conta Cox (snake_case)
  documentos_debe  Documento[] @relation("DocumentoCuentaDebe")
  documentos_haber Documento[] @relation("DocumentoCuentaHaber")
  partidas         Partida[]

  @@index([nomenclaturaId, orden])
}

model RegimenIvaFila {
  id                         Int      @id @default(autoincrement())
  orden                      Int
  idRegimen                  Int
 // regimenSistema             String
  nombreRegimen              String
  nombreComun                String
  porcentajeIva              Float
  periodo                    String
  presentaAnual              String
  limiteSalarioActual        Float
  cantidadSalariosAnio       Float
  limiteFacturacionAnual     Float
  lugarVenta                 String
  tipoActividad              String
  opcionSujetoRetencionIva   String
  porcentajeRetencionIva     Float
  montoRetencionMayorIgual   Float
  opcionExentoIva            String
  presentaFacturas           String
  retencionIva               String
  retencionIsr               String
  presentanIso               String
  presentaInventarios        String
  libroCompras               String
  libroVentas                String
  libroDiario                String
  libroDiarioDetalle         String
  libroMayor                 String
  balanceGeneralEstadoResult String
  estadosFinancieros         String
  conciliacionBancaria       String
  asientoContable            String
  tenantId                   Int?
  tenant                     Tenant?  @relation(fields: [tenantId], references: [id])
  isSeed                     Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  // ðŸ”™ Back-relation nombrada
  afiliacionesIVA Afiliaciones[] @relation("Afiliaciones_RegimenIva")

  @@index([tenantId])
}

model RegimenIsrFila {
  id                         Int      @id @default(autoincrement())
  orden                      Int
  idRegimen                  Int
  //regimenSistema             String
  nombreRegimen              String
  nombreComun                String
  porcentajeIsr              Float
  paraIsrDe                  Float
  hastaIsrDe                 Float
  periodo                    String
  presentaAnual              String
  limiteSalarioActual        Float
  cantidadSalariosAnio       Float
  limiteFacturacionAnual     Float
  lugarVenta                 String
  tipoActividad              String
  opcionSujetoRetencionIsr   String
  presentaFacturas           String
  retencionIva               String
  retencionIsr               String
  presentanIso               String
  presentaInventarios        String
  libroCompras               String
  libroVentas                String
  libroDiario                String
  libroDiarioDetalle         String
  libroMayor                 String
  balanceGeneralEstadoResult String
  estadosFinancieros         String
  conciliacionBancaria       String
  asientoContable            String
  tenantId                   Int?
  tenant                     Tenant?  @relation(fields: [tenantId], references: [id])
  isSeed                     Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  // ðŸ”™ Back-relation nombrada
  afiliacionesISR Afiliaciones[] @relation("Afiliaciones_RegimenIsr")

  @@index([tenantId])
}

/* =========================
 * Tareas
 * ========================= */

model Tarea {
  id           Int        @id @default(autoincrement())
  tenantId     Int
  userId       Int
  titulo       String
  estado       TaskEstado @default(PENDIENTE)
  tipo         String?
  fecha        DateTime?
  recordatorio Boolean    @default(false)
  empresa      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, userId, estado, fecha])
}

/* =========================
 * Empresas
 * ========================= */

model Empresa {
  id               Int          @id @default(autoincrement())
  tenantId         Int
  tenant           Tenant       @relation(fields: [tenantId], references: [id])
  tenantSlug       String       @map("tenant")
  nombre           String
  nit              String
  sectorEconomico  String
  razonSocial      RazonSocial
  avatarUrl        String?
  estado           Int      @default(1)         
  infoIndividual   Json?
  infoJuridico     Json?
  direccionFiscal  Json?
  contacto         Json?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relaciones
  afiliaciones     Afiliaciones? @relation(fields: [afiliacionesId], references: [id])
  afiliacionesId   Int? @unique
  gestiones        Gestiones?    @relation(fields: [gestionesId], references: [id])
  gestionesId      Int? @unique

  cuentasBancarias CuentaBancaria[]

  // Relaciones Conta Cox
  establecimientos          Establecimiento[]
  documentos                Documento[]
  retenciones_iva           RetencionIva[]
  retenciones_isr           RetencionIsr[]
  formulario_isr_opcional   FormularioIsrOpcionalMensual[]
  iva_general_mensual       IvaGeneralMensual[]
  asientos_contables        AsientoContable[]
  partidas                  Partida[]
  folios_sat                Folio[]
  clientes                  Cliente[]
  proveedores               Proveedor[]
  cobros                    Cobro[]
  pagos                     Pago[]
  cierres_mensuales         CierreMensual[]

  @@index([tenantId])
  @@index([tenantSlug, nit], name: "idx_empresa_tenant_nit")
}


model Afiliaciones {
  id             Int           @id @default(autoincrement())
  empresa        Empresa?

  regimenIvaId   Int?
  regimenIsrId   Int?
  nomenclaturaId Int?

  // ðŸ‘‡ Relaciones nombradas + FKs
  regimenIva     RegimenIvaFila? @relation("Afiliaciones_RegimenIva", fields: [regimenIvaId], references: [id])
  regimenIsr     RegimenIsrFila? @relation("Afiliaciones_RegimenIsr", fields: [regimenIsrId], references: [id])
  nomenclatura   Nomenclatura?   @relation("Afiliaciones_Nomenclatura", fields: [nomenclaturaId], references: [id])
  accountingMode AccountingMode  @default(DEVENGO)

  obligaciones   Obligacion[]

  @@index([regimenIvaId])
  @@index([regimenIsrId])
  @@index([nomenclaturaId])
}

model Obligacion {
  id                 Int           @id @default(autoincrement())
  afiliaciones       Afiliaciones  @relation(fields: [afiliacionesId], references: [id])
  afiliacionesId     Int
  impuesto           String
  codigoFormulario   String?
  fechaPresentacion  DateTime?
  nombreObligacion   String?
}

model Gestiones {
  id            Int          @id @default(autoincrement())
  empresa       Empresa?
  folios        FolioLibro[]
  correlativos  Json?
}

model FolioLibro {
  id           Int        @id @default(autoincrement())
  gestiones    Gestiones  @relation(fields: [gestionesId], references: [id])
  gestionesId  Int
  libro        String
  disponibles  Int        @default(0)
  usados       Int        @default(0)
  ultimaFecha  DateTime?
}

model CuentaBancaria {
  id               Int                 @id @default(autoincrement())
  empresa          Empresa             @relation(fields: [empresaId], references: [id])
  empresaId        Int

  numero           String
  banco            String
  descripcion      String?
  moneda           String
  saldoInicial     Decimal             @db.Decimal(18, 2)

  cuentaContableId Int?
  cuentaContable   NomenclaturaCuenta? @relation(fields: [cuentaContableId], references: [id])

  // ðŸ”™ Movimientos Conta Cox (snake_case en la tabla)
  movimientos_cuentas_bancarias MovimientoCuentaBancaria[]
  documentos                    Documento[]
  cobros                        Cobro[]
  pagos                         Pago[]

  @@index([empresaId])
  @@index([cuentaContableId])
}

model Cliente {
  id         Int      @id @default(autoincrement())
  empresa_id Int
  nit        String?
  nombre     String
  estado     Int      @default(1)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  empresa     Empresa                   @relation(fields: [empresa_id], references: [id])
  cobros      Cobro[]
  documentos  Documento[]

  @@map("clientes")
  @@index([empresa_id])
}

model Proveedor {
  id         Int      @id @default(autoincrement())
  empresa_id Int
  nit        String?
  nombre     String
  estado     Int      @default(1)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  empresa     Empresa                  @relation(fields: [empresa_id], references: [id])
  pagos       Pago[]
  documentos  Documento[]

  @@map("proveedores")
  @@index([empresa_id])
}

model Cobro {
  id                 Int      @id @default(autoincrement())
  empresa_id         Int
  cuenta_bancaria_id Int?
  cliente_id         Int?
  fecha              DateTime @db.Date
  monto              Decimal  @db.Decimal(20, 2)
  referencia         String?
  estado             Int      @default(1)
  asiento_contable_id Int?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  empresa         Empresa         @relation(fields: [empresa_id], references: [id])
  cuenta_bancaria CuentaBancaria? @relation(fields: [cuenta_bancaria_id], references: [id])
  cliente         Cliente?        @relation(fields: [cliente_id], references: [id])
  asiento_contable AsientoContable? @relation(fields: [asiento_contable_id], references: [id])

  aplicaciones AplicacionPagoDocumento[]

  @@map("cobros")
  @@index([empresa_id])
  @@index([cuenta_bancaria_id])
  @@index([cliente_id])
  @@index([asiento_contable_id])
}

model Pago {
  id                 Int      @id @default(autoincrement())
  empresa_id         Int
  cuenta_bancaria_id Int?
  proveedor_id       Int?
  fecha              DateTime @db.Date
  monto              Decimal  @db.Decimal(20, 2)
  referencia         String?
  estado             Int      @default(1)
  asiento_contable_id Int?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  empresa          Empresa         @relation(fields: [empresa_id], references: [id])
  cuenta_bancaria  CuentaBancaria? @relation(fields: [cuenta_bancaria_id], references: [id])
  proveedor        Proveedor?      @relation(fields: [proveedor_id], references: [id])
  asiento_contable AsientoContable? @relation(fields: [asiento_contable_id], references: [id])

  aplicaciones AplicacionPagoDocumento[]

  @@map("pagos")
  @@index([empresa_id])
  @@index([cuenta_bancaria_id])
  @@index([proveedor_id])
  @@index([asiento_contable_id])
}

model AplicacionPagoDocumento {
  id             Int      @id @default(autoincrement())
  pago_id        Int?
  cobro_id       Int?
  documento_uuid String   @db.Char(36)
  monto_aplicado Decimal  @db.Decimal(20, 2)
  created_at     DateTime @default(now())

  pago      Pago?     @relation(fields: [pago_id], references: [id])
  cobro     Cobro?    @relation(fields: [cobro_id], references: [id])
  documento Documento @relation(fields: [documento_uuid], references: [uuid])

  @@map("aplicacion_pagos_documentos")
  @@index([pago_id])
  @@index([cobro_id])
  @@index([documento_uuid])
}

/* =========================================================
 * AQUI EMPIEZAN LOS MODELOS CONTA COX EN SNAKE_CASE
 * (CAMPOS = snake_case, TABLAS = @@map() a los nombres SQL)
 * ========================================================= */

/* --- ENUM para tipo_movimiento en movimientos_cuentas_bancarias --- */
enum TipoMovimientoBancario {
  debito
  credito
}

enum EstadoConciliacion {
  PENDIENTE
  CONCILIADO
}

/* --- establecimientos --- */

model Establecimiento {
  id                                Int      @id @default(autoincrement())
  nombre                            String
  numero_de_establecimiento         String
  direccion_comercial               String?
  fecha_de_inicio_de_operaciones    DateTime? @db.Date
  tipo_de_establecimiento           String?
  clasificacion_por_establecimiento String?
  actividad_economica               String?
  estado                            Int       @default(1)

  empresa_id Int
  empresa    Empresa @relation(fields: [empresa_id], references: [id])

  documentos Documento[]

  @@map("establecimientos")
  @@index([empresa_id])
}

/* --- movimientos_cuentas_bancarias --- */

model MovimientoCuentaBancaria {
  id                 Int                    @id @default(autoincrement())
  cuenta_bancaria_id Int
  asiento_contable_id Int?
  documento_uuid     String?                @db.Char(36)
  fecha              DateTime               @db.Date
  descripcion        String?
  tipo_movimiento    TipoMovimientoBancario
  monto              Decimal                @db.Decimal(15, 2)
  referencia         String?
  estado             Int                    @default(1)
  estado_conciliacion EstadoConciliacion    @default(PENDIENTE)
  match_id           String?

  cuenta_bancaria  CuentaBancaria  @relation(fields: [cuenta_bancaria_id], references: [id])
  asiento_contable AsientoContable? @relation(fields: [asiento_contable_id], references: [id])
  documento        Documento?      @relation(fields: [documento_uuid], references: [uuid])

  @@map("movimientos_cuentas_bancarias")
  @@index([cuenta_bancaria_id])
  @@index([asiento_contable_id])
  @@index([documento_uuid])
  @@index([estado_conciliacion])
}

/* --- documentos --- */

model Documento {
  uuid                        String   @id @db.Char(36)
  numero_autorizacion         String
  fecha_trabajo               DateTime @db.Date
  fecha_emision               DateTime @db.Date
  tipo_dte                    String
  serie                       String
  numero_dte                  String
  identificador_unico         String   @unique
  nit_emisor                  String
  nombre_emisor               String
  codigo_establecimiento      String
  establecimiento_receptor_id Int?
  nombre_establecimiento      String
  id_receptor                 String
  nombre_receptor             String
  nit_certificador            String
  nombre_certificador         String
  moneda                      String
  monto_total                 Decimal  @db.Decimal(20, 2)
  monto_servicio              Decimal? @db.Decimal(20, 2)
  monto_bien                  Decimal? @db.Decimal(20, 2)
  factura_estado              String
  marca_anulado               String
  fecha_anulacion             DateTime? @db.Date
  iva                         Decimal   @db.Decimal(10, 2)
  petroleo                    Decimal   @db.Decimal(10, 2)
  turismo_hospedaje           Decimal   @db.Decimal(10, 2)
  turismo_pasajes             Decimal   @db.Decimal(10, 2)
  timbre_prensa               Decimal   @db.Decimal(10, 2)
  bomberos                    Decimal   @db.Decimal(10, 2)
  tasa_municipal              Decimal   @db.Decimal(10, 2)
  bebidas_alcoholicas         Decimal   @db.Decimal(10, 2)
  tabaco                      Decimal   @db.Decimal(10, 2)
  cemento                     Decimal   @db.Decimal(10, 2)
  bebidas_no_alcoholicas      Decimal   @db.Decimal(10, 2)
  tarifa_portuaria            Decimal   @db.Decimal(10, 2)
  tipo_operacion              String

  // ðŸ”— AquÃ­ usamos Int y lo conectamos a NomenclaturaCuenta.id
  cuenta_debe                 Int?
  cuenta_haber                Int?
  condicion_pago              CondicionPago?
  cuenta_bancaria_id          Int?
  asiento_contable_id         Int?
  cliente_id                  Int?
  proveedor_id                Int?
  tercero_ref                 Json?
  tipo                        String?

  empresa_id                  Int
  estado                      Int       @default(1)
  comentario                  String?

  empresa                  Empresa             @relation(fields: [empresa_id], references: [id])
  establecimiento_receptor Establecimiento?    @relation(fields: [establecimiento_receptor_id], references: [id])
  cuentaDebe               NomenclaturaCuenta? @relation("DocumentoCuentaDebe", fields: [cuenta_debe], references: [id])
  cuentaHaber              NomenclaturaCuenta? @relation("DocumentoCuentaHaber", fields: [cuenta_haber], references: [id])
  cuenta_bancaria          CuentaBancaria?     @relation(fields: [cuenta_bancaria_id], references: [id])
  asiento_contable         AsientoContable?    @relation(fields: [asiento_contable_id], references: [id])
  cliente                  Cliente?            @relation(fields: [cliente_id], references: [id])
  proveedor                Proveedor?         @relation(fields: [proveedor_id], references: [id])

  movimientos_bancarios    MovimientoCuentaBancaria[]
  aplicaciones_pago        AplicacionPagoDocumento[]

  @@map("documentos")
  @@index([empresa_id], name: "empresa_id_idx")
  @@index([numero_dte], name: "numero_dte_idx")
  @@index([establecimiento_receptor_id], name: "establecimiento_receptor_idx")
  @@index([cuenta_debe], name: "cuenta_debe_idx")
  @@index([cuenta_haber], name: "cuenta_haber_idx")
  @@index([cuenta_bancaria_id], name: "cuenta_bancaria_idx")
  @@index([asiento_contable_id], name: "asiento_contable_idx")
  @@index([cliente_id], name: "cliente_idx")
  @@index([proveedor_id], name: "proveedor_idx")
}

/* --- retenciones_iva --- */

model RetencionIva {
  uuid              String   @id @db.Char(36)
  empresa_id        Int
  fecha_trabajo     DateTime @db.Date
  nit_retenedor     String
  nombre_retenedor  String
  estado_constancia String
  constancia        String
  fecha_emision     DateTime @db.Date
  total_factura     Decimal  @db.Decimal(10, 2)
  importe_neto      Decimal  @db.Decimal(10, 2)
  afecto_retencion  Decimal  @db.Decimal(10, 2)
  total_retencion   Decimal  @db.Decimal(10, 2)

  empresa Empresa @relation(fields: [empresa_id], references: [id])

  @@map("retenciones_iva")
  @@index([empresa_id])
}

/* --- retenciones_isr --- */

model RetencionIsr {
  uuid              String   @id @db.Char(36)
  empresa_id        Int
  fecha_trabajo     DateTime @db.Date
  nit_retenedor     String
  nombre_retenedor  String
  estado_constancia String
  constancia        String
  fecha_emision     DateTime @db.Date
  total_factura     Decimal  @db.Decimal(10, 2)
  renta_imponible   Decimal  @db.Decimal(10, 2)
  total_retencion   Decimal  @db.Decimal(10, 2)

  empresa Empresa @relation(fields: [empresa_id], references: [id])

  @@map("retenciones_isr")
  @@index([empresa_id])
}

/* --- formulario_isr_opcional_mensual --- */

model FormularioIsrOpcionalMensual {
  uuid                   String   @id @db.Char(36)
  monto_bienes           Decimal? @db.Decimal(20, 2)
  monto_servicios        Decimal? @db.Decimal(20, 2)
  monto_descuentos       Decimal? @db.Decimal(20, 2)
  iva                    Decimal? @db.Decimal(20, 2)
  monto_base             Decimal? @db.Decimal(20, 2)
  facturas_emitidas      Int?
  retenciones_isr        Int?
  monto_isr_porcentaje_5 Decimal? @db.Decimal(20, 2)
  monto_isr_porcentaje_7 Decimal? @db.Decimal(20, 2)
  isr                    Decimal? @db.Decimal(20, 2)
  isr_retenido           Decimal? @db.Decimal(20, 2)
  isr_x_pagar            Decimal? @db.Decimal(20, 2)
  empresa_id             Int?
  fecha_trabajo          DateTime @db.Date
  estado                 Int      @default(1)

  empresa Empresa? @relation(fields: [empresa_id], references: [id])

  @@map("formulario_isr_opcional_mensual")
  @@index([empresa_id])
}

/* --- iva_general_mensual --- */

model IvaGeneralMensual {
  uuid                          String   @id @db.Char(36)
  debito_total                  Decimal? @db.Decimal(20, 2)
  remanente_credito             Decimal? @db.Decimal(20, 2)
  credito_total                 Decimal? @db.Decimal(20, 2)
  credito_periodo_siguiente     Decimal? @db.Decimal(20, 2)
  remanente_retenciones         Decimal? @db.Decimal(20, 2)
  retenciones_recibidas         Decimal? @db.Decimal(20, 2)
  retenciones_periodo_siguiente Decimal? @db.Decimal(20, 2)
  impuesto_a_pagar              Decimal? @db.Decimal(20, 2)
  empresa_id                    Int?
  fecha_trabajo                 DateTime @db.Date
  estado                        Int      @default(1)

  empresa Empresa? @relation(fields: [empresa_id], references: [id])

  @@map("iva_general_mensual")
  @@index([empresa_id])
}

/* --- tipos_polizas --- */

model TipoPoliza {
  id     Int    @id @default(autoincrement())
  nombre String
  estado Int    @default(1)

  asientos_contables AsientoContable[]

  @@map("tipos_polizas")
}

/* --- asientos_contables --- */

model AsientoContable {
  id             Int      @id @default(autoincrement())
  correlativo    Int
  tipo_poliza_id Int
  descripcion    String?
  referencia     String?
  fecha          DateTime @db.Date
  estado         Int      @default(1)
  empresa_id     Int

  tipo_poliza TipoPoliza @relation(fields: [tipo_poliza_id], references: [id])
  empresa     Empresa    @relation(fields: [empresa_id], references: [id])

  partidas             Partida[]
  documentos           Documento[]
  movimientos_bancarios MovimientoCuentaBancaria[]
  cobros               Cobro[]
  pagos                Pago[]

  @@map("asientos_contables")
  @@index([empresa_id])
  @@index([tipo_poliza_id])
}

/* --- partidas --- */

model Partida {
  uuid                String   @id @db.Char(36)
  monto_debe          Decimal  @db.Decimal(20, 2)
  monto_haber         Decimal  @db.Decimal(20, 2)
  referencia          String?
  cuenta_id           Int
  empresa_id          Int?
  asiento_contable_id Int

  cuenta           NomenclaturaCuenta @relation(fields: [cuenta_id], references: [id])
  empresa          Empresa?           @relation(fields: [empresa_id], references: [id])
  asiento_contable AsientoContable    @relation(fields: [asiento_contable_id], references: [id])

  @@map("partidas")
  @@index([empresa_id])
  @@index([cuenta_id])
  @@index([asiento_contable_id])
}

/* --- bitacora --- */

model Bitacora {
  id                    Int      @id @default(autoincrement())
  usuario_id            Int
  tipo_accion           String
  descripcion_accion    String?  @db.Text
  tabla_afectada        String?
  registro_afectado_id  Int?
  detalles_modificacion String?  @db.Text
  fecha_accion          DateTime @default(now())

  usuario User @relation(fields: [usuario_id], references: [id])

  @@map("bitacora")
  @@index([usuario_id])
}

model CierreMensual {
  id         Int      @id @default(autoincrement())
  empresa_id Int
  year       Int
  month      Int
  is_closed  Boolean  @default(false)
  closed_at  DateTime?
  closed_by  Int?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  empresa       Empresa @relation(fields: [empresa_id], references: [id])
  closedByUser  User?   @relation("UserClosedPeriods", fields: [closed_by], references: [id])

  @@map("cierres_mensuales")
  @@unique([empresa_id, year, month], name: "ux_cierres_empresa_year_month")
  @@index([empresa_id])
  @@index([closed_by])
}

/* --- libros_contables --- */

model LibroContable {
  id           Int    @id @default(autoincrement())
  nombre_libro String

  folios Folio[]

  @@map("libros_contables")
}

/* --- folios --- */

model Folio {
  id                 Int      @id @default(autoincrement())
  empresa_id         Int
  libro_contable_id  Int
  folios_disponibles Int      @default(0)
  contador_folios    Int      @default(0)
  fecha_habilitacion DateTime @db.Date

  empresa       Empresa       @relation(fields: [empresa_id], references: [id])
  libro_contable LibroContable @relation(fields: [libro_contable_id], references: [id])

  @@map("folios")
  @@index([empresa_id])
  @@index([libro_contable_id])
}
